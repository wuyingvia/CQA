这个页面是为了记录在写代码过程中出现的一些疑惑性点。
unconformality scores是一个值。在计算所有的误差之后取的某个百分位的值，代表
如果计算分位数：
    先排序， 合计有len(数组)-1个间隔，每个四分位为[len(数组)-1个间隔]/4;计算第一个四分位时，等于第一个位置加上四分位间隔*1的位置上的值
比如[0，1，2，3，4，5]，先排序，计算间隔5/4=1.25，第一个四分位1+1.25=2.25，等于第二位的值1，及第2位和第3位0.25处的值；0+（2-1）*0.25
calibration 求的interval需要在inverse_transform之后，否则数据会很奇怪[54.601257  75.54322   54.78423   75.72619   54.50849   75.45045]?
数据不奇怪，正常数据
quantile loss
原理是预测给定某个百分位的值，像mqrnn是直接改了最后一层线形层，loss function是等于几个百分位数的线性和，error1*q+erro1*(1-q),
像https://github.com/strongio/quantile-regression-tensorflow/blob/master/Quantile%20Loss.ipynb，他取的是最大值
改最后线性层的困难在于本来输出的[batch, 1,1 node],变成[batch*node,1]，经过线性层[batch*node,expert],维度可能会变化，所以按照另一个GitHub来做
计算三个网络，计算三份loss，loss combination
this blog is the Quantile Regression https://medium.com/the-artificial-impostor/quantile-regression-part-1-e25bdd8d9d43
https://blog.csdn.net/jesseyule/article/details/95247155 这个是比较好的分位数回归分析的讲解
回归分析一般是通过最小化MSE来进行，最后本质是为了得到一个期望，在预测过程中，本质上是在一个条件期望，在x等于某个值，根据数据，求y的期望
分位数回归提出的原因是，不仅仅希望研究y的期望，而是希望探索y的完整分布状态
或者说希望得到y的某个分位数
如何确定分位数
可以通过
![img.png](img.png)
给不同y值（大于分位点和小于分位点的y）不同权重，比如有一个np.arange([1,10]),
希望求0.7分位数，假设这个0.7分位数是q，所有大于q的数被附上权重0.7，小于q的赋予权重0.3，
最小化q
得到回归曲线的含义，有70%的数据在这个曲线的下方

full comformal prediction 要重复计算很多次，所以没有计算
不确定性是在训练过程中就可以产生region，
for i in 类别：
    x_aug = {x_new, x_train,}
    y_aug = {y_fakelabel, y_train,}
    f.fit(x_aug, y_aug)
    y_hat = f(x_aug)
    redidual = abs(y_hat - y_aug)
    residual[1] = sum(residual[1:]> residual[0])+1/n+1
    # 这个的意思是x_new预测出来的误差要是比train的误差小
return residual
这个适合不是那么复杂的模型，因为要retrain

而split conformal prediction不适合小数据以及需要去确定分割比例，因为train的数据少了，模型训练不好，cal训练数据少了，
模型不确定性不准确；以及，当数据漂移的时候，覆盖率会下降



result
08/06/2022-17/06/2022 is the result 
the process data is in 
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/base_pred_PEMS-BAY_STGCN3_2206071714
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/bayesianpred_PEMS-BAY_STGCN3_2206171012
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/dopout0.1pred_PEMS-BAY_STGCN3_2206101444
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/dropout0.5pred_PEMS-BAY_STGCN3_2206101423
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/dropout0.9pred_PEMS-BAY_STGCN3_2206101413
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical - W_PEMS-BAY_HistoricalAverage_2206101404
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.1 pred_PEMS-BAY_HistoricalAverage_2206161615
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.2 pred_PEMS-BAY_HistoricalAverage_2206161616
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.3 pred_PEMS-BAY_HistoricalAverage_2206161617
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.4 pred_PEMS-BAY_HistoricalAverage_2206161618
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.5 pred_PEMS-BAY_HistoricalAverage_2206161619
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.6 pred_PEMS-BAY_HistoricalAverage_2206161620
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/Historical – W with Static Gaussian 0.7 pred_PEMS-BAY_HistoricalAverage_2206161624
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/mq0.8pred_PEMS-BAY_STGCN3_2206152005
/home/wuying/CODE/reference/2022/DL-Traff-Graph-main/save/mq0.9pred_PEMS-BAY_STGCN3_2206151952

有些数据没有了，新的数据

这个是conformal quantile ，其中，第二次quan取0.8
/home/wuying/CODE/mymodel/2022/DL-Traff-Graph/v1_save/cqr_0.8_pred_PEMS-BAY_STGCN1_2207122030

23/07/2022
可能v1版本会有错误，后面测试的都是12step，stgcn貌似只有一步，检查一下
metra-la stgcn12 cqr 
Mean independent coverage, Mean confidence interval widths, 0.9793, 89.7031
这个结果interval太宽了。

25/7/2022
更正错误，最后pred需要大于0
/home/wuying/CODE/mymodel/2022/DL-Traff-Graph/save/pred_PEMSD7M_STGCN12_cqr_2207252009/
/home/wuying/CODE/mymodel/2022/DL-Traff-Graph/save/pred_PEMS-BAY_TGCN_cqr_2207211915/
/home/wuying/CODE/mymodel/2022/DL-Traff-Graph/save/pred_PEMS-BAY_STGCN12_cqr_2207261030
/home/wuying/CODE/mymodel/2022/DL-Traff-Graph/save/pred_PEMS-BAY_GraphWaveNet_cqr2207211701
/home/wuying/CODE/mymodel/2022/DL-Traff-Graph/save/pred_METR-LA_STGCN12_cqr_2207261505